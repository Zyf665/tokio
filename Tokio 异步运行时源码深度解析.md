# Tokio å¼‚æ­¥è¿è¡Œæ—¶æºç æ·±åº¦è§£æ

åŸºäºä½ åœ¨å­¦ä¹  Tokio æºç è¿‡ç¨‹ä¸­çš„æé—®å’Œç†è§£ï¼Œæˆ‘æ¥ä¸ºä½ æ•´ç†ä¸€ä»½ç³»ç»Ÿæ€§çš„æŠ€æœ¯è¯¦è§£ã€‚

## ğŸ“š ç›®å½•

1. [Tokio æ•´ä½“æ¶æ„æ¦‚è§ˆ](#1-tokio-æ•´ä½“æ¶æ„æ¦‚è§ˆ)
2. [ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†](#2-ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†)
3. [è°ƒåº¦ç³»ç»Ÿæ·±å…¥è§£æ](#3-è°ƒåº¦ç³»ç»Ÿæ·±å…¥è§£æ)
4. [è¶…æ—¶æœºåˆ¶ä¸ä»»åŠ¡å–æ¶ˆ](#4-è¶…æ—¶æœºåˆ¶ä¸ä»»åŠ¡å–æ¶ˆ)
5. [è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç³»ç»Ÿ](#5-è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç³»ç»Ÿ)
6. [å±‚å±‚æŠ½è±¡çš„è®¾è®¡æ¨¡å¼](#6-å±‚å±‚æŠ½è±¡çš„è®¾è®¡æ¨¡å¼)
7. [æ ¸å¿ƒè°ƒç”¨é“¾è·¯æ¢³ç†](#7-æ ¸å¿ƒè°ƒç”¨é“¾è·¯æ¢³ç†)

---

## 1. Tokio æ•´ä½“æ¶æ„æ¦‚è§ˆ

### ğŸ—ï¸ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ· API å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  tokio::spawn()  â”‚  tokio::timeout()  â”‚  tokio::sleep()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Runtime å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Handle::spawn() â”‚  Context ç®¡ç†  â”‚  è°ƒåº¦å™¨æ¥å£             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è°ƒåº¦å™¨å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¤šçº¿ç¨‹è°ƒåº¦å™¨   â”‚  æœ¬åœ°é˜Ÿåˆ—    â”‚  å…¨å±€æ³¨å…¥é˜Ÿåˆ—              â”‚
â”‚  å·¥ä½œçªƒå–       â”‚  LIFO æ§½ä½   â”‚  åä½œå¼è°ƒåº¦                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä»»åŠ¡ç®¡ç†å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Task<S>        â”‚  Notified<S>  â”‚  JoinHandle<T>           â”‚
â”‚  çŠ¶æ€ç®¡ç†       â”‚  å¼•ç”¨è®¡æ•°     â”‚  ç”Ÿå‘½å‘¨æœŸæ§åˆ¶              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº•å±‚æ‰§è¡Œå±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Future::poll() â”‚  Waker æœºåˆ¶   â”‚  åä½œå¼å–æ¶ˆ               â”‚
â”‚  çŠ¶æ€è½¬æ¢       â”‚  å†…å­˜ç®¡ç†     â”‚  èµ„æºæ¸…ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”‘ æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®ç±»å‹ |
|------|------|----------|
| **Runtime** | è¿è¡Œæ—¶ç®¡ç† | `Runtime`, `Handle` |
| **Scheduler** | ä»»åŠ¡è°ƒåº¦ | `Scheduler`, `Worker` |
| **Task** | ä»»åŠ¡æŠ½è±¡ | `Task<S>`, `Notified<S>`, `JoinHandle<T>` |
| **Context** | ä¸Šä¸‹æ–‡ç®¡ç† | `Context`, çº¿ç¨‹æœ¬åœ°å­˜å‚¨ |
| **Future** | å¼‚æ­¥æŠ½è±¡ | `Future`, `Poll`, `Waker` |

---

## 2. ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

### ğŸ”„ ä»»åŠ¡çŠ¶æ€è½¬æ¢å›¾

```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   åˆ›å»º      â”‚
          â”‚ (Created)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ new_task()
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ç»‘å®š      â”‚
          â”‚ (Bound)     â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ bind()
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   è°ƒåº¦      â”‚
          â”‚(Scheduled)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ schedule()
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         é€šçŸ¥             â”‚
    â”‚      (Notified)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ poll()
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        è¿è¡Œ             â”‚
    â”‚      (Running)          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
    Poll::Pending   Poll::Ready
         â”‚              â”‚
         â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    ç©ºé—²     â”‚ â”‚    å®Œæˆ     â”‚
    â”‚   (Idle)    â”‚ â”‚(Complete)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
         â”‚ å¯è¢«å–æ¶ˆ        â”‚ èµ„æºæ¸…ç†
         â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å–æ¶ˆ      â”‚ â”‚   é‡Šæ”¾      â”‚
    â”‚(Cancelled)  â”‚ â”‚(Released)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š ä»»åŠ¡çŠ¶æ€ä½å­—æ®µ

```rust
// ä»»åŠ¡çŠ¶æ€åŸå­ usize çš„ä½å­—æ®µå¸ƒå±€
struct TaskState {
    // ä½ 0: ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ
    RUNNING: bool,
    
    // ä½ 1: Future æ˜¯å¦å·²å®Œæˆ
    COMPLETE: bool,
    
    // ä½ 2: æ˜¯å¦å­˜åœ¨ Notified å¯¹è±¡
    NOTIFIED: bool,
    
    // ä½ 3: ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
    CANCELLED: bool,
    
    // ä½ 4: æ˜¯å¦å­˜åœ¨ JoinHandle
    JOIN_INTEREST: bool,
    
    // ä½ 5: JoinHandle waker è®¿é—®æ§åˆ¶
    JOIN_WAKER: bool,
    
    // ä½ 16-31: å¼•ç”¨è®¡æ•°
    REF_COUNT: u16,
}
```

### ğŸ”§ æ ¸å¿ƒä»»åŠ¡ç±»å‹

```rust
/// åŸºç¡€ä»»åŠ¡ç±»å‹ - å¼•ç”¨è®¡æ•°ç®¡ç†
pub(crate) struct Task<S: 'static> {
    raw: RawTask,
    _p: PhantomData<S>,
}

/// å·²é€šçŸ¥çš„ä»»åŠ¡ - å‡†å¤‡æ‰§è¡Œ
pub(crate) struct Notified<S: 'static>(Task<S>);

/// æœ¬åœ°é€šçŸ¥ä»»åŠ¡ - é Send
pub(crate) struct LocalNotified<S: 'static> {
    task: Task<S>,
    _not_send: PhantomData<*const ()>,
}

/// ç”¨æˆ·å¥æŸ„ - è·å–ç»“æœ
pub struct JoinHandle<T> {
    raw: RawTask,
    _p: PhantomData<T>,
}
```

---

## 3. è°ƒåº¦ç³»ç»Ÿæ·±å…¥è§£æ

### ğŸ­ å¤šçº¿ç¨‹è°ƒåº¦å™¨æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         å…¨å±€æ³¨å…¥é˜Ÿåˆ—                â”‚
                    â”‚      (Global Inject Queue)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ å·¥ä½œçªƒå–
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worker 0      â”‚   Worker 1      â”‚   Worker 2      â”‚   Worker N      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚
â”‚ â”‚(Local Queue)â”‚ â”‚ â”‚(Local Queue)â”‚ â”‚ â”‚(Local Queue)â”‚ â”‚ â”‚(Local Queue)â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                   â–²                   â–²                   â–²
         â”‚                   â”‚                   â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                   â”‚
                        å·¥ä½œçªƒå–ç®—æ³•          å·¥ä½œçªƒå–ç®—æ³•
```

### âš¡ è°ƒåº¦ç­–ç•¥è¯¦è§£

#### 1. **ä»»åŠ¡æ”¾ç½®ç­–ç•¥**

```rust
// æ ¹æ®å½“å‰ä¸Šä¸‹æ–‡å†³å®šä»»åŠ¡æ”¾ç½®ä½ç½®
fn schedule_task(task: Notified<Self>, is_yield: bool) {
    if let Some(core) = self.core.borrow_mut().as_mut() {
        // åœ¨å·¥ä½œçº¿ç¨‹ä¸­
        if is_yield {
            // yield æ“ä½œï¼šæ”¾å…¥æœ¬åœ°é˜Ÿåˆ—æœ«å°¾
            core.run_queue.push_back(task);
        } else {
            // æ–°ä»»åŠ¡ï¼šä¼˜å…ˆæ”¾å…¥ LIFO æ§½ä½ï¼ˆæé«˜å±€éƒ¨æ€§ï¼‰
            if let Some(prev_task) = core.lifo_slot.take() {
                core.run_queue.push_back(prev_task);
            }
            core.lifo_slot = Some(task);
        }
    } else {
        // ä¸åœ¨å·¥ä½œçº¿ç¨‹ä¸­ï¼šæ”¾å…¥å…¨å±€æ³¨å…¥é˜Ÿåˆ—
        self.inject.push(task);
        self.notify_parked_worker();
    }
}
```

#### 2. **å·¥ä½œçªƒå–ç®—æ³•**

```rust
// Worker æŸ¥æ‰¾ä»»åŠ¡çš„ä¼˜å…ˆçº§é¡ºåº
fn next_task() -> Option<Notified<Self>> {
    // 1. æ£€æŸ¥ LIFO æ§½ä½ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå±€éƒ¨æ€§æœ€å¥½ï¼‰
    if let Some(task) = self.lifo_slot.take() {
        return Some(task);
    }
    
    // 2. æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—
    if let Some(task) = self.run_queue.pop_front() {
        return Some(task);
    }
    
    // 3. ä»å…¨å±€æ³¨å…¥é˜Ÿåˆ—çªƒå–
    if let Some(task) = self.inject.steal_batch(&mut self.run_queue) {
        return Some(task);
    }
    
    // 4. ä»å…¶ä»– Worker çªƒå–
    for other_worker in &self.workers {
        if let Some(task) = other_worker.steal() {
            return Some(task);
        }
    }
    
    None
}
```

### ğŸ¯ åä½œå¼è°ƒåº¦

```rust
// åä½œå¼è°ƒåº¦é¢„ç®—ç³»ç»Ÿ
pub(crate) struct Budget {
    remaining: u8,
}

impl Budget {
    const INITIAL: u8 = 128;
    
    pub(crate) fn has_remaining(&self) -> bool {
        self.remaining > 0
    }
    
    pub(crate) fn consume(&mut self) -> bool {
        if self.remaining > 0 {
            self.remaining -= 1;
            true
        } else {
            false
        }
    }
}

// åœ¨ä»»åŠ¡è½®è¯¢æ—¶æ£€æŸ¥é¢„ç®—
fn poll_with_budget<F: Future>(mut future: Pin<&mut F>, cx: &mut Context) -> Poll<F::Output> {
    if !coop::has_budget_remaining() {
        // é¢„ç®—è€—å°½ï¼Œè®©å‡ºæ‰§è¡Œæƒ
        cx.waker().wake_by_ref();
        return Poll::Pending;
    }
    
    // æ¶ˆè€—ä¸€ä¸ªé¢„ç®—å•ä½
    coop::consume_budget();
    
    // è½®è¯¢ Future
    future.as_mut().poll(cx)
}
```

---

## 4. è¶…æ—¶æœºåˆ¶ä¸ä»»åŠ¡å–æ¶ˆ

### â° è¶…æ—¶å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è°ƒç”¨      â”‚    â”‚   Timeout       â”‚    â”‚   å»¶è¿Ÿè®¡æ—¶å™¨    â”‚
â”‚ timeout(dur,f)  â”‚â”€â”€â”€â–¶â”‚   Future        â”‚â”€â”€â”€â–¶â”‚   (Delay)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   è½®è¯¢é€»è¾‘      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  å…ˆè½®è¯¢å†…éƒ¨     â”‚    â”‚  å†æ£€æŸ¥è¶…æ—¶     â”‚
            â”‚   Future        â”‚    â”‚   è®¡æ—¶å™¨        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â–¼                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Poll::Ready(v)  â”‚    â”‚ Poll::Ready(()) â”‚
            â”‚ â†’ Ok(v)         â”‚    â”‚ â†’ Err(Elapsed)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ” è¶…æ—¶å®ç°æºç è§£æ

```rust
impl<T> Future for Timeout<T>
where
    T: Future,
{
    type Output = Result<T::Output, Elapsed>;

    fn poll(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output> {
        let me = self.project();
        
        let had_budget_before = coop::has_budget_remaining();

        // ğŸ¯ å…³é”®è®¾è®¡ï¼šå…ˆè½®è¯¢å†…éƒ¨ Future
        if let Poll::Ready(v) = me.value.poll(cx) {
            return Poll::Ready(Ok(v));  // å³ä½¿è¶…æ—¶ä¹Ÿè¿”å›æˆåŠŸ
        }

        let has_budget_now = coop::has_budget_remaining();

        // æ£€æŸ¥è¶…æ—¶
        let poll_delay = || -> Poll<Self::Output> {
            match me.delay.poll(cx) {
                Poll::Ready(()) => Poll::Ready(Err(Elapsed::new())),
                Poll::Pending => Poll::Pending,
            }
        };

        // å¤„ç†åä½œå¼è°ƒåº¦è¾¹ç•Œæƒ…å†µ
        if let (true, false) = (had_budget_before, has_budget_now) {
            // å¦‚æœå†…éƒ¨ Future è€—å°½äº†é¢„ç®—ï¼Œç”¨æ— çº¦æŸé¢„ç®—æ£€æŸ¥è¶…æ—¶
            coop::with_unconstrained(poll_delay)
        } else {
            poll_delay()
        }
    }
}
```

**ğŸ¤” ä¸ºä»€ä¹ˆå…ˆè½®è¯¢ Future å†æ£€æŸ¥è¶…æ—¶ï¼Ÿ**

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¦‚æœ Future å·²ç» Readyï¼Œé¿å…ä¸å¿…è¦çš„æ—¶é—´æ£€æŸ¥
2. **è¯­ä¹‰ä¸€è‡´æ€§**ï¼šç¬¦åˆ Rust Future çš„åŸå­æ€§è¦æ±‚
3. **é¿å…ç«æ€**ï¼šé˜²æ­¢æ£€æŸ¥-è½®è¯¢ä¹‹é—´çš„æ—¶é—´çª—å£é—®é¢˜

### ğŸš« ä»»åŠ¡å–æ¶ˆæœºåˆ¶

#### 1. **å–æ¶ˆè°ƒç”¨é“¾**

```
JoinHandle::abort()
       â”‚
       â–¼
Task::abort()
       â”‚
       â–¼
RawTask::remote_abort()
       â”‚
       â–¼
State::transition_to_notified_and_cancel()
       â”‚
       â–¼
Task::schedule() (å¦‚æœéœ€è¦)
       â”‚
       â–¼
Worker è½®è¯¢æ—¶æ£€æŸ¥ CANCELLED ä½
       â”‚
       â–¼
cancel_task() â†’ æ¸…ç†èµ„æº
```

#### 2. **çŠ¶æ€è½¬æ¢è¯¦è§£**

```rust
pub(super) fn transition_to_notified_and_cancel(&self) -> bool {
    self.fetch_update_action(|mut snapshot| {
        if snapshot.is_cancelled() || snapshot.is_complete() {
            // å·²å–æ¶ˆæˆ–å·²å®Œæˆçš„ä»»åŠ¡ï¼šæ— æ“ä½œ
            (false, None)
        } else if snapshot.is_running() {
            // æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼šæ ‡è®°å–æ¶ˆï¼Œè¿è¡Œçº¿ç¨‹ä¼šæ£€æŸ¥
            snapshot.set_notified();
            snapshot.set_cancelled();
            (false, Some(snapshot))
        } else {
            // ç©ºé—²ä»»åŠ¡ï¼šæ ‡è®°å–æ¶ˆå¹¶é€šçŸ¥è°ƒåº¦
            snapshot.set_cancelled();
            if !snapshot.is_notified() {
                snapshot.set_notified();
                snapshot.ref_inc();  // å¢åŠ å¼•ç”¨è®¡æ•°
                (true, Some(snapshot))  // éœ€è¦è°ƒåº¦
            } else {
                (false, Some(snapshot))
            }
        }
    })
}
```

#### 3. **åä½œå¼å–æ¶ˆ**

```rust
// åœ¨ä»»åŠ¡è½®è¯¢è¿‡ç¨‹ä¸­æ£€æŸ¥å–æ¶ˆçŠ¶æ€
fn poll_inner(&self) -> PollFuture {
    match self.state().transition_to_running() {
        TransitionToRunning::Success => {
            // æ­£å¸¸è½®è¯¢ Future
            let res = poll_future(self.core(), cx);
            
            if res == Poll::Ready(()) {
                return PollFuture::Complete;
            }

            // è½®è¯¢å®Œæˆåæ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
            let transition_res = self.state().transition_to_idle();
            if let TransitionToIdle::Cancelled = transition_res {
                cancel_task(self.core());  // æ‰§è¡Œå–æ¶ˆæ¸…ç†
            }
            
            transition_result_to_poll_future(transition_res)
        }
        TransitionToRunning::Cancelled => {
            // å¯åŠ¨æ—¶å°±å‘ç°è¢«å–æ¶ˆ
            cancel_task(self.core());
            PollFuture::Complete
        }
        // ... å…¶ä»–çŠ¶æ€
    }
}
```

---

## 5. è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç³»ç»Ÿ

### ğŸ—‚ï¸ ä¸Šä¸‹æ–‡ç»“æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONTEXT (çº¿ç¨‹æœ¬åœ°å­˜å‚¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  thread_id  â”‚ â”‚   current   â”‚ â”‚  scheduler  â”‚ â”‚   rng   â”‚ â”‚
â”‚ â”‚   çº¿ç¨‹ID    â”‚ â”‚  è¿è¡Œæ—¶å¥æŸ„  â”‚ â”‚  è°ƒåº¦å™¨ä¸Šä¸‹æ–‡â”‚ â”‚ éšæœºæ•°  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚current_task â”‚ â”‚   runtime   â”‚ â”‚   budget    â”‚ â”‚  trace  â”‚ â”‚
â”‚ â”‚  å½“å‰ä»»åŠ¡ID â”‚ â”‚  è¿è¡Œæ—¶çŠ¶æ€  â”‚ â”‚  åä½œé¢„ç®—   â”‚ â”‚ è¿½è¸ªä¿¡æ¯â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”§ ä¸Šä¸‹æ–‡è®¿é—®æ¨¡å¼

```rust
// å…¸å‹çš„ä¸Šä¸‹æ–‡è®¿é—®æ¨¡å¼
pub fn spawn<T>(future: T) -> JoinHandle<T::Output>
where
    T: Future + Send + 'static,
    T::Output: Send + 'static,
{
    // é€šè¿‡ä¸Šä¸‹æ–‡è·å–å½“å‰è¿è¡Œæ—¶å¥æŸ„
    match context::with_current(|handle| handle.spawn(future, id)) {
        Ok(join_handle) => join_handle,
        Err(e) => panic!("no current runtime: {}", e),
    }
}

// ä¸Šä¸‹æ–‡è®¿é—®çš„åº•å±‚å®ç°
pub(crate) fn with_current<F, R>(f: F) -> Result<R, TryCurrentError>
where
    F: FnOnce(&scheduler::Handle) -> R,
{
    CONTEXT.try_with(|ctx| {
        // è·å–å½“å‰è¿è¡Œæ—¶å¥æŸ„çš„å¼•ç”¨
        ctx.current.handle.borrow().as_ref().map(f)
    })
    .unwrap_or(Err(TryCurrentError::new_no_context()))
    .unwrap_or(Err(TryCurrentError::new_thread_local_destroyed()))
}
```

### ğŸ›ï¸ ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†

```rust
// è¿›å…¥è¿è¡Œæ—¶æ—¶è®¾ç½®ä¸Šä¸‹æ–‡
pub(crate) fn enter_runtime<F, R>(
    handle: &scheduler::Handle,
    allow_block_in_place: bool,
    f: F
) -> R
where
    F: FnOnce(&mut BlockingRegionGuard) -> R,
{
    CONTEXT.with(|c| {
        if c.runtime.get().is_entered() {
            panic!("Cannot start a runtime from within a runtime");
        }
        
        // è®¾ç½®è¿è¡Œæ—¶çŠ¶æ€
        c.runtime.set(EnterRuntime::Entered { allow_block_in_place });
        
        // è®¾ç½®å½“å‰è¿è¡Œæ—¶å¥æŸ„
        let handle_guard = c.set_current(handle);
        
        // åˆ›å»ºè¿›å…¥å®ˆæŠ¤
        let guard = EnterRuntimeGuard {
            blocking: BlockingRegionGuard::new(),
            handle: handle_guard,
        };
        
        // åœ¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œç”¨æˆ·ä»£ç 
        f(&mut guard.blocking)
    })
}
```

---

## 6. å±‚å±‚æŠ½è±¡çš„è®¾è®¡æ¨¡å¼

### ğŸ—ï¸ æŠ½è±¡å±‚æ¬¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ· API å±‚                             â”‚
â”‚  tokio::spawn(), tokio::timeout(), tokio::sleep()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ç®€åŒ–æ¥å£ï¼Œéšè—å¤æ‚æ€§
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Runtime å±‚                              â”‚
â”‚  Handle::spawn(), Context ç®¡ç†, ç”Ÿå‘½å‘¨æœŸæ§åˆ¶                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è¿è¡Œæ—¶æŠ½è±¡ï¼Œèµ„æºç®¡ç†
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è°ƒåº¦å™¨æŠ½è±¡å±‚                              â”‚
â”‚  Schedule trait, å¤šç§è°ƒåº¦å™¨å®ç°                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è°ƒåº¦ç­–ç•¥æŠ½è±¡
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä»»åŠ¡æŠ½è±¡å±‚                               â”‚
â”‚  Task<S>, Notified<S>, çŠ¶æ€ç®¡ç†                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸæŠ½è±¡
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº•å±‚æ‰§è¡Œå±‚                                â”‚
â”‚  RawTask, å†…å­˜ç®¡ç†, Future è½®è¯¢                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¨ è®¾è®¡æ¨¡å¼åº”ç”¨

#### 1. **ç­–ç•¥æ¨¡å¼ (Strategy Pattern)**

```rust
// è°ƒåº¦å™¨ç­–ç•¥æŠ½è±¡
pub(crate) trait Schedule: Sync + Sized + 'static {
    fn release(&self, task: &Task<Self>) -> Option<Task<Self>>;
    fn schedule(&self, task: Notified<Self>);
    fn yield_now(&self, task: Notified<Self>);
    fn unhandled_panic(&self);
}

// å¤šçº¿ç¨‹è°ƒåº¦å™¨å®ç°
impl Schedule for MultiThread {
    fn schedule(&self, task: Notified<Self>) {
        self.shared.schedule_task(task, false);
    }
}

// å½“å‰çº¿ç¨‹è°ƒåº¦å™¨å®ç°
impl Schedule for CurrentThread {
    fn schedule(&self, task: Notified<Self>) {
        self.context.run_queue.push_back(task);
    }
}
```

#### 2. **é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)**

```rust
// å°†ä¸åŒå¤§å°çš„ Future é€‚é…ä¸ºç»Ÿä¸€æ¥å£
pub fn spawn<F>(future: F) -> JoinHandle<F::Output>
where
    F: Future + Send + 'static,
{
    let fut_size = std::mem::size_of::<F>();
    if fut_size > BOX_FUTURE_THRESHOLD {
        // å¤§ Futureï¼šè£…ç®±åˆ°å †ä¸Š
        spawn_inner(Box::pin(future), SpawnMeta::new_unnamed(fut_size))
    } else {
        // å° Futureï¼šç›´æ¥ä½¿ç”¨
        spawn_inner(future, SpawnMeta::new_unnamed(fut_size))
    }
}
```

#### 3. **ä»£ç†æ¨¡å¼ (Proxy Pattern)**

```rust
// JoinHandle ä½œä¸ºä»»åŠ¡çš„ä»£ç†
pub struct JoinHandle<T> {
    raw: RawTask,
    _p: PhantomData<T>,
}

impl<T> JoinHandle<T> {
    // ä»£ç†ä»»åŠ¡å–æ¶ˆæ“ä½œ
    pub fn abort(&self) {
        self.raw.remote_abort();
    }
    
    // ä»£ç†è·å–ä»»åŠ¡ç»“æœ
    pub async fn await(self) -> Result<T, JoinError> {
        // å®é™…ç­‰å¾…ä»»åŠ¡å®Œæˆçš„é€»è¾‘
    }
}
```

#### 4. **è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)**

```rust
// Waker ä½œä¸ºè§‚å¯Ÿè€…ï¼Œç›‘å¬ä»»åŠ¡çŠ¶æ€å˜åŒ–
impl Wake for TaskWaker {
    fn wake(self: Arc<Self>) {
        self.header().state.transition_to_notified_by_val();
        self.header().schedule();
    }
    
    fn wake_by_ref(self: &Arc<Self>) {
        self.header().state.transition_to_notified_by_ref();
        self.header().schedule();
    }
}
```

---

## 7. æ ¸å¿ƒè°ƒç”¨é“¾è·¯æ¢³ç†

### ğŸš€ ä»»åŠ¡ç”Ÿæˆå®Œæ•´è°ƒç”¨é“¾

```
tokio::spawn(future)
       â”‚
       â–¼
spawn_inner(future, meta)
       â”‚
       â–¼
context::with_current(|handle| handle.spawn(future, id))
       â”‚
       â–¼
Handle::spawn(future, id)
       â”‚
       â–¼
Spawner::spawn(future, id)
       â”‚
       â–¼
new_task(future, scheduler, id)
       â”‚
       â”œâ”€ åˆ›å»º Task<S>
       â”œâ”€ åˆ›å»º Notified<S>  
       â””â”€ åˆ›å»º JoinHandle<T>
       â”‚
       â–¼
OwnedTasks::bind(task, scheduler, id)
       â”‚
       â”œâ”€ å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
       â””â”€ è¿”å› (JoinHandle, Option<Notified>)
       â”‚
       â–¼
task_hooks.spawn(TaskMeta { id })  // ç”Ÿæˆé’©å­
       â”‚
       â–¼
schedule_option_task_without_yield(notified)  // è°ƒåº¦ä»»åŠ¡
       â”‚
       â–¼
schedule_task(notified, false)
       â”‚
       â”œâ”€ å¦‚æœåœ¨å·¥ä½œçº¿ç¨‹ â†’ æœ¬åœ°é˜Ÿåˆ—/LIFOæ§½ä½
       â””â”€ å¦‚æœä¸åœ¨å·¥ä½œçº¿ç¨‹ â†’ å…¨å±€æ³¨å…¥é˜Ÿåˆ—
```

### âš¡ ä»»åŠ¡æ‰§è¡Œè°ƒç”¨é“¾

```
Worker::run()
       â”‚
       â–¼
Worker::next_task()
       â”‚
       â”œâ”€ æ£€æŸ¥ LIFO æ§½ä½
       â”œâ”€ æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—  
       â”œâ”€ ä»å…¨å±€é˜Ÿåˆ—çªƒå–
       â””â”€ ä»å…¶ä»– Worker çªƒå–
       â”‚
       â–¼
LocalNotified::run()
       â”‚
       â–¼
Harness::poll()
       â”‚
       â–¼
Harness::poll_inner()
       â”‚
       â”œâ”€ state.transition_to_running()
       â”œâ”€ poll_future(core, cx)
       â””â”€ state.transition_to_idle()
       â”‚
       â–¼
poll_future(core, cx)
       â”‚
       â–¼
Future::poll(cx)  // ç”¨æˆ·çš„ Future
       â”‚
       â”œâ”€ Poll::Ready(output) â†’ complete_task()
       â””â”€ Poll::Pending â†’ ä»»åŠ¡é‡æ–°è°ƒåº¦
```

### ğŸ• è¶…æ—¶å¤„ç†è°ƒç”¨é“¾

```
tokio::time::timeout(duration, future)
       â”‚
       â–¼
Timeout::new(Delay::new(duration), future)
       â”‚
       â–¼
Timeout::poll(cx)
       â”‚
       â”œâ”€ coop::has_budget_remaining()  // æ£€æŸ¥é¢„ç®—
       â”œâ”€ inner_future.poll(cx)         // å…ˆè½®è¯¢å†…éƒ¨ Future
       â”‚  â””â”€ Poll::Ready(v) â†’ Ok(v)     // å³ä½¿è¶…æ—¶ä¹Ÿè¿”å›æˆåŠŸ
       â””â”€ delay.poll(cx)                // å†æ£€æŸ¥è¶…æ—¶
          â””â”€ Poll::Ready(()) â†’ Err(Elapsed)
```

### ğŸš« ä»»åŠ¡å–æ¶ˆè°ƒç”¨é“¾

```
JoinHandle::abort()
       â”‚
       â–¼
Task::abort()
       â”‚
       â–¼
RawTask::remote_abort()
       â”‚
       â–¼
State::transition_to_notified_and_cancel()
       â”‚
       â”œâ”€ å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œ â†’ è®¾ç½® CANCELLED ä½
       â”œâ”€ å¦‚æœä»»åŠ¡ç©ºé—² â†’ è®¾ç½® CANCELLED + NOTIFIED ä½
       â””â”€ è¿”å›æ˜¯å¦éœ€è¦è°ƒåº¦
       â”‚
       â–¼ (å¦‚æœéœ€è¦è°ƒåº¦)
Harness::schedule()
       â”‚
       â–¼
Worker ä¸‹æ¬¡è½®è¯¢æ—¶æ£€æŸ¥ CANCELLED ä½
       â”‚
       â–¼
cancel_task(core)
       â”‚
       â”œâ”€ panic::catch_unwind(|| core.drop_future_or_output())
       â””â”€ core.store_output(Err(JoinError::Cancelled))
```

---

## ğŸ¯ å…³é”®è®¾è®¡æ€æƒ³æ€»ç»“

### 1. **é›¶æˆæœ¬æŠ½è±¡ (Zero-Cost Abstractions)**
- ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œè¿è¡Œæ—¶æ— é¢å¤–å¼€é”€
- æ³›å‹ç‰¹åŒ–ï¼Œé¿å…åŠ¨æ€åˆ†å‘
- å†…è”ä¼˜åŒ–ï¼Œæ¶ˆé™¤å‡½æ•°è°ƒç”¨å¼€é”€

### 2. **å†…å­˜å®‰å…¨ (Memory Safety)**
- å¼•ç”¨è®¡æ•°ç®¡ç†ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
- åŸå­æ“ä½œç¡®ä¿å¹¶å‘å®‰å…¨
- RAII æ¨¡å¼è‡ªåŠ¨èµ„æºæ¸…ç†

### 3. **åä½œå¼è°ƒåº¦ (Cooperative Scheduling)**
- ä»»åŠ¡ä¸»åŠ¨è®©å‡º CPU
- é¢„ç®—ç³»ç»Ÿé˜²æ­¢ä»»åŠ¡é¥¿æ­»
- éæŠ¢å å¼ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

### 4. **å·¥ä½œçªƒå– (Work Stealing)**
- è´Ÿè½½å‡è¡¡ï¼Œæé«˜ CPU åˆ©ç”¨ç‡
- å±€éƒ¨æ€§ä¼˜åŒ–ï¼Œå‡å°‘ç¼“å­˜æœªå‘½ä¸­
- åŠ¨æ€è°ƒæ•´ï¼Œé€‚åº”è´Ÿè½½å˜åŒ–

### 5. **å±‚æ¬¡åŒ–è®¾è®¡ (Layered Architecture)**
- èŒè´£åˆ†ç¦»ï¼Œé™ä½è€¦åˆåº¦
- æ¥å£æŠ½è±¡ï¼Œæé«˜å¯æ‰©å±•æ€§
- ç»„åˆæ¨¡å¼ï¼Œçµæ´»é…ç½®

è¿™ä»½è¯¦è§£æ¶µç›–äº†ä½ åœ¨å­¦ä¹  Tokio æºç è¿‡ç¨‹ä¸­é‡åˆ°çš„æ ¸å¿ƒé—®é¢˜å’Œæ¦‚å¿µã€‚æ¯ä¸ªéƒ¨åˆ†éƒ½ç»“åˆäº†å…·ä½“çš„ä»£ç ç¤ºä¾‹å’Œå›¾è¡¨è¯´æ˜ï¼Œå¸Œæœ›èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ Tokio çš„è®¾è®¡æ€æƒ³å’Œå®ç°åŸç†ã€‚

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ· API å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  tokio::spawn()  â”‚  tokio::timeout()  â”‚  tokio::sleep()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Runtime å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Handle::spawn() â”‚  Context ç®¡ç†  â”‚  è°ƒåº¦å™¨æ¥å£             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è°ƒåº¦å™¨å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¤šçº¿ç¨‹è°ƒåº¦å™¨   â”‚  æœ¬åœ°é˜Ÿåˆ—    â”‚  å…¨å±€æ³¨å…¥é˜Ÿåˆ—              â”‚
â”‚  å·¥ä½œçªƒå–       â”‚  LIFO æ§½ä½   â”‚  åä½œå¼è°ƒåº¦                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä»»åŠ¡ç®¡ç†å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Task<S>        â”‚  Notified<S>  â”‚  JoinHandle<T>           â”‚
â”‚  çŠ¶æ€ç®¡ç†       â”‚  å¼•ç”¨è®¡æ•°     â”‚  ç”Ÿå‘½å‘¨æœŸæ§åˆ¶              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº•å±‚æ‰§è¡Œå±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Future::poll() â”‚  Waker æœºåˆ¶   â”‚  åä½œå¼å–æ¶ˆ               â”‚
â”‚  çŠ¶æ€è½¬æ¢       â”‚  å†…å­˜ç®¡ç†     â”‚  èµ„æºæ¸…ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```plaintext
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   åˆ›å»º      â”‚
          â”‚ (Created)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ new_task()
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ç»‘å®š      â”‚
          â”‚ (Bound)     â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ bind()
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   è°ƒåº¦      â”‚
          â”‚(Scheduled)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ schedule()
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         é€šçŸ¥             â”‚
    â”‚      (Notified)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ poll()
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        è¿è¡Œ             â”‚
    â”‚      (Running)          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
    Poll::Pending   Poll::Ready
         â”‚              â”‚
         â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    ç©ºé—²     â”‚ â”‚    å®Œæˆ     â”‚
    â”‚   (Idle)    â”‚ â”‚(Complete)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
         â”‚ å¯è¢«å–æ¶ˆ        â”‚ èµ„æºæ¸…ç†
         â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å–æ¶ˆ      â”‚ â”‚   é‡Šæ”¾      â”‚
    â”‚(Cancelled)  â”‚ â”‚(Released)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```rust
// ä»»åŠ¡çŠ¶æ€åŸå­ usize çš„ä½å­—æ®µå¸ƒå±€
struct TaskState {
    // ä½ 0: ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ
    RUNNING: bool,
    
    // ä½ 1: Future æ˜¯å¦å·²å®Œæˆ
    COMPLETE: bool,
    
    // ä½ 2: æ˜¯å¦å­˜åœ¨ Notified å¯¹è±¡
    NOTIFIED: bool,
    
    // ä½ 3: ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
    CANCELLED: bool,
    
    // ä½ 4: æ˜¯å¦å­˜åœ¨ JoinHandle
    JOIN_INTEREST: bool,
    
    // ä½ 5: JoinHandle waker è®¿é—®æ§åˆ¶
    JOIN_WAKER: bool,
    
    // ä½ 16-31: å¼•ç”¨è®¡æ•°
    REF_COUNT: u16,
}
```

```rust
/// åŸºç¡€ä»»åŠ¡ç±»å‹ - å¼•ç”¨è®¡æ•°ç®¡ç†
pub(crate) struct Task<S: 'static> {
    raw: RawTask,
    _p: PhantomData<S>,
}

/// å·²é€šçŸ¥çš„ä»»åŠ¡ - å‡†å¤‡æ‰§è¡Œ
pub(crate) struct Notified<S: 'static>(Task<S>);

/// æœ¬åœ°é€šçŸ¥ä»»åŠ¡ - é Send
pub(crate) struct LocalNotified<S: 'static> {
    task: Task<S>,
    _not_send: PhantomData<*const ()>,
}

/// ç”¨æˆ·å¥æŸ„ - è·å–ç»“æœ
pub struct JoinHandle<T> {
    raw: RawTask,
    _p: PhantomData<T>,
}
```

```plaintext
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         å…¨å±€æ³¨å…¥é˜Ÿåˆ—                â”‚
                    â”‚      (Global Inject Queue)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ å·¥ä½œçªƒå–
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worker 0      â”‚   Worker 1      â”‚   Worker 2      â”‚   Worker N      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚ â”‚ LIFO æ§½ä½   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚ â”‚  æœ¬åœ°é˜Ÿåˆ—   â”‚ â”‚
â”‚ â”‚(Local Queue)â”‚ â”‚ â”‚(Local Queue)â”‚ â”‚ â”‚(Local Queue)â”‚ â”‚ â”‚(Local Queue)â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                   â–²                   â–²                   â–²
         â”‚                   â”‚                   â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                   â”‚
                        å·¥ä½œçªƒå–ç®—æ³•          å·¥ä½œçªƒå–ç®—æ³•
```

```rust
// æ ¹æ®å½“å‰ä¸Šä¸‹æ–‡å†³å®šä»»åŠ¡æ”¾ç½®ä½ç½®
fn schedule_task(task: Notified<Self>, is_yield: bool) {
    if let Some(core) = self.core.borrow_mut().as_mut() {
        // åœ¨å·¥ä½œçº¿ç¨‹ä¸­
        if is_yield {
            // yield æ“ä½œï¼šæ”¾å…¥æœ¬åœ°é˜Ÿåˆ—æœ«å°¾
            core.run_queue.push_back(task);
        } else {
            // æ–°ä»»åŠ¡ï¼šä¼˜å…ˆæ”¾å…¥ LIFO æ§½ä½ï¼ˆæé«˜å±€éƒ¨æ€§ï¼‰
            if let Some(prev_task) = core.lifo_slot.take() {
                core.run_queue.push_back(prev_task);
            }
            core.lifo_slot = Some(task);
        }
    } else {
        // ä¸åœ¨å·¥ä½œçº¿ç¨‹ä¸­ï¼šæ”¾å…¥å…¨å±€æ³¨å…¥é˜Ÿåˆ—
        self.inject.push(task);
        self.notify_parked_worker();
    }
}
```

```rust
// Worker æŸ¥æ‰¾ä»»åŠ¡çš„ä¼˜å…ˆçº§é¡ºåº
fn next_task() -> Option<Notified<Self>> {
    // 1. æ£€æŸ¥ LIFO æ§½ä½ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå±€éƒ¨æ€§æœ€å¥½ï¼‰
    if let Some(task) = self.lifo_slot.take() {
        return Some(task);
    }
    
    // 2. æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—
    if let Some(task) = self.run_queue.pop_front() {
        return Some(task);
    }
    
    // 3. ä»å…¨å±€æ³¨å…¥é˜Ÿåˆ—çªƒå–
    if let Some(task) = self.inject.steal_batch(&mut self.run_queue) {
        return Some(task);
    }
    
    // 4. ä»å…¶ä»– Worker çªƒå–
    for other_worker in &self.workers {
        if let Some(task) = other_worker.steal() {
            return Some(task);
        }
    }
    
    None
}
```

```rust
// åä½œå¼è°ƒåº¦é¢„ç®—ç³»ç»Ÿ
pub(crate) struct Budget {
    remaining: u8,
}

impl Budget {
    const INITIAL: u8 = 128;
    
    pub(crate) fn has_remaining(&self) -> bool {
        self.remaining > 0
    }
    
    pub(crate) fn consume(&mut self) -> bool {
        if self.remaining > 0 {
            self.remaining -= 1;
            true
        } else {
            false
        }
    }
}

// åœ¨ä»»åŠ¡è½®è¯¢æ—¶æ£€æŸ¥é¢„ç®—
fn poll_with_budget<F: Future>(mut future: Pin<&mut F>, cx: &mut Context) -> Poll<F::Output> {
    if !coop::has_budget_remaining() {
        // é¢„ç®—è€—å°½ï¼Œè®©å‡ºæ‰§è¡Œæƒ
        cx.waker().wake_by_ref();
        return Poll::Pending;
    }
    
    // æ¶ˆè€—ä¸€ä¸ªé¢„ç®—å•ä½
    coop::consume_budget();
    
    // è½®è¯¢ Future
    future.as_mut().poll(cx)
}
```

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è°ƒç”¨      â”‚    â”‚   Timeout       â”‚    â”‚   å»¶è¿Ÿè®¡æ—¶å™¨    â”‚
â”‚ timeout(dur,f)  â”‚â”€â”€â”€â–¶â”‚   Future        â”‚â”€â”€â”€â–¶â”‚   (Delay)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   è½®è¯¢é€»è¾‘      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  å…ˆè½®è¯¢å†…éƒ¨     â”‚    â”‚  å†æ£€æŸ¥è¶…æ—¶     â”‚
            â”‚   Future        â”‚    â”‚   è®¡æ—¶å™¨        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â–¼                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Poll::Ready(v)  â”‚    â”‚ Poll::Ready(()) â”‚
            â”‚ â†’ Ok(v)         â”‚    â”‚ â†’ Err(Elapsed)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```rust
impl<T> Future for Timeout<T>
where
    T: Future,
{
    type Output = Result<T::Output, Elapsed>;

    fn poll(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output> {
        let me = self.project();
        
        let had_budget_before = coop::has_budget_remaining();

        // ğŸ¯ å…³é”®è®¾è®¡ï¼šå…ˆè½®è¯¢å†…éƒ¨ Future
        if let Poll::Ready(v) = me.value.poll(cx) {
            return Poll::Ready(Ok(v));  // å³ä½¿è¶…æ—¶ä¹Ÿè¿”å›æˆåŠŸ
        }

        let has_budget_now = coop::has_budget_remaining();

        // æ£€æŸ¥è¶…æ—¶
        let poll_delay = || -> Poll<Self::Output> {
            match me.delay.poll(cx) {
                Poll::Ready(()) => Poll::Ready(Err(Elapsed::new())),
                Poll::Pending => Poll::Pending,
            }
        };

        // å¤„ç†åä½œå¼è°ƒåº¦è¾¹ç•Œæƒ…å†µ
        if let (true, false) = (had_budget_before, has_budget_now) {
            // å¦‚æœå†…éƒ¨ Future è€—å°½äº†é¢„ç®—ï¼Œç”¨æ— çº¦æŸé¢„ç®—æ£€æŸ¥è¶…æ—¶
            coop::with_unconstrained(poll_delay)
        } else {
            poll_delay()
        }
    }
}
```

```plaintext
JoinHandle::abort()
       â”‚
       â–¼
Task::abort()
       â”‚
       â–¼
RawTask::remote_abort()
       â”‚
       â–¼
State::transition_to_notified_and_cancel()
       â”‚
       â–¼
Task::schedule() (å¦‚æœéœ€è¦)
       â”‚
       â–¼
Worker è½®è¯¢æ—¶æ£€æŸ¥ CANCELLED ä½
       â”‚
       â–¼
cancel_task() â†’ æ¸…ç†èµ„æº
```

```rust
pub(super) fn transition_to_notified_and_cancel(&self) -> bool {
    self.fetch_update_action(|mut snapshot| {
        if snapshot.is_cancelled() || snapshot.is_complete() {
            // å·²å–æ¶ˆæˆ–å·²å®Œæˆçš„ä»»åŠ¡ï¼šæ— æ“ä½œ
            (false, None)
        } else if snapshot.is_running() {
            // æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼šæ ‡è®°å–æ¶ˆï¼Œè¿è¡Œçº¿ç¨‹ä¼šæ£€æŸ¥
            snapshot.set_notified();
            snapshot.set_cancelled();
            (false, Some(snapshot))
        } else {
            // ç©ºé—²ä»»åŠ¡ï¼šæ ‡è®°å–æ¶ˆå¹¶é€šçŸ¥è°ƒåº¦
            snapshot.set_cancelled();
            if !snapshot.is_notified() {
                snapshot.set_notified();
                snapshot.ref_inc();  // å¢åŠ å¼•ç”¨è®¡æ•°
                (true, Some(snapshot))  // éœ€è¦è°ƒåº¦
            } else {
                (false, Some(snapshot))
            }
        }
    })
}
```

```rust
// åœ¨ä»»åŠ¡è½®è¯¢è¿‡ç¨‹ä¸­æ£€æŸ¥å–æ¶ˆçŠ¶æ€
fn poll_inner(&self) -> PollFuture {
    match self.state().transition_to_running() {
        TransitionToRunning::Success => {
            // æ­£å¸¸è½®è¯¢ Future
            let res = poll_future(self.core(), cx);
            
            if res == Poll::Ready(()) {
                return PollFuture::Complete;
            }

            // è½®è¯¢å®Œæˆåæ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
            let transition_res = self.state().transition_to_idle();
            if let TransitionToIdle::Cancelled = transition_res {
                cancel_task(self.core());  // æ‰§è¡Œå–æ¶ˆæ¸…ç†
            }
            
            transition_result_to_poll_future(transition_res)
        }
        TransitionToRunning::Cancelled => {
            // å¯åŠ¨æ—¶å°±å‘ç°è¢«å–æ¶ˆ
            cancel_task(self.core());
            PollFuture::Complete
        }
        // ... å…¶ä»–çŠ¶æ€
    }
}
```

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONTEXT (çº¿ç¨‹æœ¬åœ°å­˜å‚¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  thread_id  â”‚ â”‚   current   â”‚ â”‚  scheduler  â”‚ â”‚   rng   â”‚ â”‚
â”‚ â”‚   çº¿ç¨‹ID    â”‚ â”‚  è¿è¡Œæ—¶å¥æŸ„  â”‚ â”‚  è°ƒåº¦å™¨ä¸Šä¸‹æ–‡â”‚ â”‚ éšæœºæ•°  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚current_task â”‚ â”‚   runtime   â”‚ â”‚   budget    â”‚ â”‚  trace  â”‚ â”‚
â”‚ â”‚  å½“å‰ä»»åŠ¡ID â”‚ â”‚  è¿è¡Œæ—¶çŠ¶æ€  â”‚ â”‚  åä½œé¢„ç®—   â”‚ â”‚ è¿½è¸ªä¿¡æ¯â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```rust
// å…¸å‹çš„ä¸Šä¸‹æ–‡è®¿é—®æ¨¡å¼
pub fn spawn<T>(future: T) -> JoinHandle<T::Output>
where
    T: Future + Send + 'static,
    T::Output: Send + 'static,
{
    // é€šè¿‡ä¸Šä¸‹æ–‡è·å–å½“å‰è¿è¡Œæ—¶å¥æŸ„
    match context::with_current(|handle| handle.spawn(future, id)) {
        Ok(join_handle) => join_handle,
        Err(e) => panic!("no current runtime: {}", e),
    }
}

// ä¸Šä¸‹æ–‡è®¿é—®çš„åº•å±‚å®ç°
pub(crate) fn with_current<F, R>(f: F) -> Result<R, TryCurrentError>
where
    F: FnOnce(&scheduler::Handle) -> R,
{
    CONTEXT.try_with(|ctx| {
        // è·å–å½“å‰è¿è¡Œæ—¶å¥æŸ„çš„å¼•ç”¨
        ctx.current.handle.borrow().as_ref().map(f)
    })
    .unwrap_or(Err(TryCurrentError::new_no_context()))
    .unwrap_or(Err(TryCurrentError::new_thread_local_destroyed()))
}
```

```rust
// è¿›å…¥è¿è¡Œæ—¶æ—¶è®¾ç½®ä¸Šä¸‹æ–‡
pub(crate) fn enter_runtime<F, R>(
    handle: &scheduler::Handle,
    allow_block_in_place: bool,
    f: F
) -> R
where
    F: FnOnce(&mut BlockingRegionGuard) -> R,
{
    CONTEXT.with(|c| {
        if c.runtime.get().is_entered() {
            panic!("Cannot start a runtime from within a runtime");
        }
        
        // è®¾ç½®è¿è¡Œæ—¶çŠ¶æ€
        c.runtime.set(EnterRuntime::Entered { allow_block_in_place });
        
        // è®¾ç½®å½“å‰è¿è¡Œæ—¶å¥æŸ„
        let handle_guard = c.set_current(handle);
        
        // åˆ›å»ºè¿›å…¥å®ˆæŠ¤
        let guard = EnterRuntimeGuard {
            blocking: BlockingRegionGuard::new(),
            handle: handle_guard,
        };
        
        // åœ¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œç”¨æˆ·ä»£ç 
        f(&mut guard.blocking)
    })
}
```

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ· API å±‚                             â”‚
â”‚  tokio::spawn(), tokio::timeout(), tokio::sleep()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ç®€åŒ–æ¥å£ï¼Œéšè—å¤æ‚æ€§
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Runtime å±‚                              â”‚
â”‚  Handle::spawn(), Context ç®¡ç†, ç”Ÿå‘½å‘¨æœŸæ§åˆ¶                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è¿è¡Œæ—¶æŠ½è±¡ï¼Œèµ„æºç®¡ç†
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è°ƒåº¦å™¨æŠ½è±¡å±‚                              â”‚
â”‚  Schedule trait, å¤šç§è°ƒåº¦å™¨å®ç°                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è°ƒåº¦ç­–ç•¥æŠ½è±¡
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä»»åŠ¡æŠ½è±¡å±‚                               â”‚
â”‚  Task<S>, Notified<S>, çŠ¶æ€ç®¡ç†                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸæŠ½è±¡
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº•å±‚æ‰§è¡Œå±‚                                â”‚
â”‚  RawTask, å†…å­˜ç®¡ç†, Future è½®è¯¢                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```rust
// è°ƒåº¦å™¨ç­–ç•¥æŠ½è±¡
pub(crate) trait Schedule: Sync + Sized + 'static {
    fn release(&self, task: &Task<Self>) -> Option<Task<Self>>;
    fn schedule(&self, task: Notified<Self>);
    fn yield_now(&self, task: Notified<Self>);
    fn unhandled_panic(&self);
}

// å¤šçº¿ç¨‹è°ƒåº¦å™¨å®ç°
impl Schedule for MultiThread {
    fn schedule(&self, task: Notified<Self>) {
        self.shared.schedule_task(task, false);
    }
}

// å½“å‰çº¿ç¨‹è°ƒåº¦å™¨å®ç°
impl Schedule for CurrentThread {
    fn schedule(&self, task: Notified<Self>) {
        self.context.run_queue.push_back(task);
    }
}
```

```rust
// å°†ä¸åŒå¤§å°çš„ Future é€‚é…ä¸ºç»Ÿä¸€æ¥å£
pub fn spawn<F>(future: F) -> JoinHandle<F::Output>
where
    F: Future + Send + 'static,
{
    let fut_size = std::mem::size_of::<F>();
    if fut_size > BOX_FUTURE_THRESHOLD {
        // å¤§ Futureï¼šè£…ç®±åˆ°å †ä¸Š
        spawn_inner(Box::pin(future), SpawnMeta::new_unnamed(fut_size))
    } else {
        // å° Futureï¼šç›´æ¥ä½¿ç”¨
        spawn_inner(future, SpawnMeta::new_unnamed(fut_size))
    }
}
```

```rust
// JoinHandle ä½œä¸ºä»»åŠ¡çš„ä»£ç†
pub struct JoinHandle<T> {
    raw: RawTask,
    _p: PhantomData<T>,
}

impl<T> JoinHandle<T> {
    // ä»£ç†ä»»åŠ¡å–æ¶ˆæ“ä½œ
    pub fn abort(&self) {
        self.raw.remote_abort();
    }
    
    // ä»£ç†è·å–ä»»åŠ¡ç»“æœ
    pub async fn await(self) -> Result<T, JoinError> {
        // å®é™…ç­‰å¾…ä»»åŠ¡å®Œæˆçš„é€»è¾‘
    }
}
```

```rust
// Waker ä½œä¸ºè§‚å¯Ÿè€…ï¼Œç›‘å¬ä»»åŠ¡çŠ¶æ€å˜åŒ–
impl Wake for TaskWaker {
    fn wake(self: Arc<Self>) {
        self.header().state.transition_to_notified_by_val();
        self.header().schedule();
    }
    
    fn wake_by_ref(self: &Arc<Self>) {
        self.header().state.transition_to_notified_by_ref();
        self.header().schedule();
    }
}
```

```plaintext
tokio::spawn(future)
       â”‚
       â–¼
spawn_inner(future, meta)
       â”‚
       â–¼
context::with_current(|handle| handle.spawn(future, id))
       â”‚
       â–¼
Handle::spawn(future, id)
       â”‚
       â–¼
Spawner::spawn(future, id)
       â”‚
       â–¼
new_task(future, scheduler, id)
       â”‚
       â”œâ”€ åˆ›å»º Task<S>
       â”œâ”€ åˆ›å»º Notified<S>  
       â””â”€ åˆ›å»º JoinHandle<T>
       â”‚
       â–¼
OwnedTasks::bind(task, scheduler, id)
       â”‚
       â”œâ”€ å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
       â””â”€ è¿”å› (JoinHandle, Option<Notified>)
       â”‚
       â–¼
task_hooks.spawn(TaskMeta { id })  // ç”Ÿæˆé’©å­
       â”‚
       â–¼
schedule_option_task_without_yield(notified)  // è°ƒåº¦ä»»åŠ¡
       â”‚
       â–¼
schedule_task(notified, false)
       â”‚
       â”œâ”€ å¦‚æœåœ¨å·¥ä½œçº¿ç¨‹ â†’ æœ¬åœ°é˜Ÿåˆ—/LIFOæ§½ä½
       â””â”€ å¦‚æœä¸åœ¨å·¥ä½œçº¿ç¨‹ â†’ å…¨å±€æ³¨å…¥é˜Ÿåˆ—
```

```plaintext
Worker::run()
       â”‚
       â–¼
Worker::next_task()
       â”‚
       â”œâ”€ æ£€æŸ¥ LIFO æ§½ä½
       â”œâ”€ æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—  
       â”œâ”€ ä»å…¨å±€é˜Ÿåˆ—çªƒå–
       â””â”€ ä»å…¶ä»– Worker çªƒå–
       â”‚
       â–¼
LocalNotified::run()
       â”‚
       â–¼
Harness::poll()
       â”‚
       â–¼
Harness::poll_inner()
       â”‚
       â”œâ”€ state.transition_to_running()
       â”œâ”€ poll_future(core, cx)
       â””â”€ state.transition_to_idle()
       â”‚
       â–¼
poll_future(core, cx)
       â”‚
       â–¼
Future::poll(cx)  // ç”¨æˆ·çš„ Future
       â”‚
       â”œâ”€ Poll::Ready(output) â†’ complete_task()
       â””â”€ Poll::Pending â†’ ä»»åŠ¡é‡æ–°è°ƒåº¦
```

```plaintext
tokio::time::timeout(duration, future)
       â”‚
       â–¼
Timeout::new(Delay::new(duration), future)
       â”‚
       â–¼
Timeout::poll(cx)
       â”‚
       â”œâ”€ coop::has_budget_remaining()  // æ£€æŸ¥é¢„ç®—
       â”œâ”€ inner_future.poll(cx)         // å…ˆè½®è¯¢å†…éƒ¨ Future
       â”‚  â””â”€ Poll::Ready(v) â†’ Ok(v)     // å³ä½¿è¶…æ—¶ä¹Ÿè¿”å›æˆåŠŸ
       â””â”€ delay.poll(cx)                // å†æ£€æŸ¥è¶…æ—¶
          â””â”€ Poll::Ready(()) â†’ Err(Elapsed)
```

```plaintext
JoinHandle::abort()
       â”‚
       â–¼
Task::abort()
       â”‚
       â–¼
RawTask::remote_abort()
       â”‚
       â–¼
State::transition_to_notified_and_cancel()
       â”‚
       â”œâ”€ å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œ â†’ è®¾ç½® CANCELLED ä½
       â”œâ”€ å¦‚æœä»»åŠ¡ç©ºé—² â†’ è®¾ç½® CANCELLED + NOTIFIED ä½
       â””â”€ è¿”å›æ˜¯å¦éœ€è¦è°ƒåº¦
       â”‚
       â–¼ (å¦‚æœéœ€è¦è°ƒåº¦)
Harness::schedule()
       â”‚
       â–¼
Worker ä¸‹æ¬¡è½®è¯¢æ—¶æ£€æŸ¥ CANCELLED ä½
       â”‚
       â–¼
cancel_task(core)
       â”‚
       â”œâ”€ panic::catch_unwind(|| core.drop_future_or_output())
       â””â”€ core.store_output(Err(JoinError::Cancelled))
```

